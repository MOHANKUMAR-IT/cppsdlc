name: Code Coverage

on:
  release:
    types: [ created, published ]

jobs:
  coverage:
    name: Generate Code Coverage
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
    
    - name: Setup CMake
      uses: lukka/get-cmake@latest
    
    - name: Configure Git for private registry
      run: |
        git config --global url."https://${{ secrets.GITHUB_TOKEN }}@github.com/".insteadOf "https://github.com/"
    
    - name: Install vcpkg
      run: |
        git clone https://github.com/microsoft/vcpkg.git
        cd vcpkg
        ./bootstrap-vcpkg.sh
    
    - name: Configure with coverage flags
      run: |
        cmake -B build -S . \
          -DCMAKE_BUILD_TYPE=Debug \
          -DCMAKE_CXX_FLAGS="--coverage" \
          -DCMAKE_EXE_LINKER_FLAGS="--coverage" \
          -DCMAKE_TOOLCHAIN_FILE=vcpkg/scripts/buildsystems/vcpkg.cmake
    
    - name: Build
      run: cmake --build build
    
    - name: Run tests
      working-directory: build
      run: ctest --output-on-failure
    
    - name: Generate coverage report
      run: |
        lcov --capture --directory build --output-file coverage.info --ignore-errors mismatch
        lcov --remove coverage.info '/usr/*' '*/vcpkg_installed/*' '*/tests/*' --output-file coverage.info
        lcov --list coverage.info
